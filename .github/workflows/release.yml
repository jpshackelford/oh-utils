name: Release

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.2.3)"
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event.workflow_run.conclusion == 'success' &&
       !contains(github.event.workflow_run.head_commit.message, 'bump:'))
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Check if release is needed
        id: check_release
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual release triggered"
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            # Check if there are any conventional commits since last tag
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -z "$LAST_TAG" ]; then
              echo "No previous tags found, creating initial release"
              echo "should_release=true" >> $GITHUB_OUTPUT
            else
              # Check for conventional commits since last tag
              COMMITS=$(git log ${LAST_TAG}..HEAD --oneline --grep="^feat\|^fix\|^perf\|BREAKING CHANGE" || true)
              if [ -n "$COMMITS" ]; then
                echo "Found conventional commits since last tag"
                echo "should_release=true" >> $GITHUB_OUTPUT
              else
                echo "No conventional commits found since last tag"
                echo "should_release=false" >> $GITHUB_OUTPUT
              fi
            fi
          fi

      - name: Determine version
        if: steps.check_release.outputs.should_release == 'true'
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.version }}"
          else
            # Get current version and increment patch
            CURRENT_VERSION=$(uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
            # Simple patch increment
            NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          fi

          echo "NEW_VERSION=v${NEW_VERSION}" >> $GITHUB_ENV
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "Creating release for version: v${NEW_VERSION}"

      - name: Build package
        if: steps.check_release.outputs.should_release == 'true'
        run: uv build

      - name: Generate changelog
        if: steps.check_release.outputs.should_release == 'true'
        run: |
          # Create a simple changelog from recent commits
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "# Release ${{ env.NEW_VERSION }}" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "Initial release" >> RELEASE_NOTES.md
          else
            echo "# Release ${{ env.NEW_VERSION }}" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "## Changes since ${LAST_TAG}" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            git log ${LAST_TAG}..HEAD --oneline --pretty=format:"- %s" >> RELEASE_NOTES.md
          fi

      - name: Create GitHub Release
        if: steps.check_release.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.NEW_VERSION }}
          name: Release ${{ env.NEW_VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: dist/*

      - name: Publish to PyPI (placeholder)
        if: steps.check_release.outputs.should_release == 'true'
        run: |
          echo "future state package publishing to PyPI"
          echo "Would publish version: ${{ env.NEW_VERSION }}"
          echo "Package files:"
          ls -la dist/

  publish-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Build package
        run: uv build

      - name: Publish to Test PyPI (placeholder)
        run: |
          echo "future state package publishing to Test PyPI"
          echo "Package files:"
          ls -la dist/
